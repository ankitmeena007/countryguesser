<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Country Guesser</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
      {
        "imports": {
          "topojson-client": "https://esm.sh/topojson-client@3.1.0",
          "d3-geo": "https://esm.sh/d3-geo@3.1.1",
          "d3-zoom": "https://esm.sh/d3-zoom@3.0.0",
          "d3-selection": "https://esm.sh/d3-selection@3.0.0",
          "d3-transition": "https://esm.sh/d3-transition@3.0.1"
        }
      }
    </script>
    <style>
        /* Add a simple fade-in animation */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        /* Add a pulse animation for the timer */
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        .animate-pulse {
            animation: pulse 1s infinite;
        }
    </style>
  </head>
  <body class="bg-slate-900 text-white antialiased overflow-hidden">
    <main class="w-screen h-screen flex flex-col md:flex-row font-sans">
        <aside class="w-full md:w-72 md:flex-shrink-0 bg-slate-800 p-2 md:p-6 flex flex-col items-center justify-start md:justify-between gap-4 md:gap-0 border-b md:border-b-0 md:border-r border-slate-700 shadow-2xl">
          <div>
            <h1 class="text-2xl sm:text-4xl font-extrabold tracking-tight text-center">Country Guesser</h1>
            <div class="mt-4 space-y-3">
              <div class="flex items-center justify-between p-2 bg-slate-700/50 rounded-lg">
                <span class="font-semibold text-base">Study Mode</span>
                <button id="study-mode-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-gray-600">
                  <span class="sr-only">Toggle Study Mode</span>
                  <span id="study-mode-switch" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-1"></span>
                </button>
              </div>
              <div class="flex items-center justify-between p-2 bg-slate-700/50 rounded-lg">
                <span class="font-semibold text-base">Timed Mode</span>
                <button id="timed-mode-toggle" class="relative inline-flex items-center h-6 rounded-full w-11 transition-colors bg-cyan-500">
                  <span class="sr-only">Toggle Timed Mode</span>
                  <span id="timed-mode-switch" class="inline-block w-4 h-4 transform bg-white rounded-full transition-transform translate-x-6"></span>
                </button>
              </div>
            </div>
          </div>
          
          <div id="game-info-panel" class="w-full">
            <!-- Game info will be rendered here by JavaScript -->
          </div>
    
          <div class="w-full">
            <h3 class="text-lg font-bold mb-1 text-center text-yellow-400 border-t border-slate-700 pt-2">High Score</h3>
            <p id="high-score" class="text-2xl sm:text-3xl font-bold text-center text-white">0 <span class="text-base font-normal text-slate-400">pts</span></p>
          </div>
        </aside>
        <div class="flex-1 flex flex-col items-center p-2 sm:p-4 relative">
          <header class="absolute top-2 sm:top-4 text-center w-full flex justify-center items-center px-4 z-10 pointer-events-none">
            <div>
              <p class="text-slate-400 mt-1 text-center text-sm sm:text-lg">Can you find the correct country on the map?</p>
            </div>
          </header>
          <div class="w-full flex-1 flex items-center justify-center pt-10 sm:pt-12">
            <div id="map-container" class="w-full h-full bg-slate-800 rounded-lg overflow-hidden shadow-lg border border-slate-700 relative">
                <svg id="world-map" width="100%" height="100%" viewBox="0 0 800 450" preserveAspectRatio="xMidYMid meet"></svg>
                <div class="absolute bottom-4 right-4 flex flex-col space-y-2 z-10">
                    <button id="zoom-in" class="w-10 h-10 sm:w-12 sm:h-12 bg-slate-700 rounded-full flex items-center justify-center text-2xl sm:text-3xl hover:bg-slate-600 transition-colors focus:outline-none focus:ring-2 focus:ring-cyan-400" aria-label="Zoom in">+</button>
                    <button id="zoom-out" class="w-10 h-10 sm:w-12 sm:h-12 bg-slate-700 rounded-full flex items-center justify-center text-2xl sm:text-3xl hover:bg-slate-600 transition-colors focus:outline-none focus:ring-2 focus:ring-cyan-400" aria-label="Zoom out">-</button>
                </div>
            </div>
          </div>
          <footer class="text-center text-slate-500 text-sm py-1">
            Made with <span class="text-red-500" role="img" aria-label="love">‚ù§Ô∏è</span> by Ankit
          </footer>
        </div>
    </main>
    <script type="module">
        import { feature } from 'topojson-client';
        import { geoMercator, geoPath, geoContains } from 'd3-geo';
        import { zoom, zoomIdentity } from 'd3-zoom';
        import { select, pointer } from 'd3-selection';
        import 'd3-transition';

        // --- Constants and State ---
        const WORLD_MAP_URL = 'https://cdn.jsdelivr.net/npm/world-atlas@2/countries-110m.json';
        const GameStatus = { LOADING: 'LOADING', PLAYING: 'PLAYING', GAME_OVER: 'GAME_OVER' };

        let gameStatus = GameStatus.LOADING;
        let countries = [];
        let playableCountries = [];
        let targetCountry = null;
        let score = 0;
        let lives = 3;
        let wrongGuesses = [];
        let streak = 0;
        let hintsLeft = 3;
        let revealedHintCountryId = null;
        let timeLeft = 60;
        let gameMode = 'PLAY';
        let isTimedMode = true;
        let highScore = 0;
        let selectedCountryId = null;
        let correctGuessId = null;
        let timerId = null;
        
        // --- D3 Map State ---
        let projection, pathGenerator, zoomBehavior;
        let currentTransform = zoomIdentity;
        let marker = null;

        // --- DOM Element References ---
        const gameInfoPanel = document.getElementById('game-info-panel');
        const highScoreEl = document.getElementById('high-score');
        const mapContainer = document.getElementById('map-container');
        const svg = select('#world-map');
        const g = svg.append('g');

        // --- UI Update Functions ---
        function renderGameInfo() {
            let content = '';
            if (gameStatus === GameStatus.LOADING) {
                content = `
                    <div class="text-center">
                        <h2 class="text-2xl font-bold">Loading Map...</h2>
                        <p class="text-slate-400">Getting the globe ready!</p>
                    </div>`;
            } else if (gameStatus === GameStatus.GAME_OVER) {
                content = `
                    <div class="w-full flex flex-col space-y-4 text-center animate-fade-in">
                        <h2 class="text-3xl font-extrabold text-red-500">Game Over</h2>
                        ${targetCountry && !correctGuessId ? `<p class="text-lg">The country was <span class="font-bold text-green-400">${targetCountry.properties.name}</span>.</p>` : ''}
                        <div>
                            <p class="text-lg text-slate-400">Final Score</p>
                            <p class="text-4xl font-bold">${score}</p>
                        </div>
                        <button id="play-again-btn" class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-500 transition-colors shadow-lg">
                            Play Again
                        </button>
                    </div>`;
            } else if (gameMode === 'STUDY') {
                content = `
                    <div class="w-full flex flex-col space-y-4 text-center">
                        <h2 class="text-3xl font-bold text-cyan-400">Study Mode</h2>
                        <p class="text-slate-400">Explore the labeled world map. Zoom and pan to learn country names and locations.</p>
                    </div>`;
            } else { // Playing mode
                const hearts = Array.from({ length: 3 }).map((_, i) =>
                    `<svg class="w-7 h-7 ${i < lives ? 'text-red-500' : 'text-slate-600'} transition-colors" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>`
                ).join('');
                const timerClass = timeLeft < 10 && isTimedMode ? 'text-red-500 animate-pulse' : 'text-white';
                
                content = `
                    <div class="w-full flex flex-col space-y-2 text-center">
                        <div>
                            <p class="text-base text-slate-400">Find this country:</p>
                            <h2 class="text-xl md:text-3xl font-bold text-cyan-400 break-words min-h-[4rem] md:h-20 flex items-center justify-center" title="${targetCountry?.properties.name || ''}">${targetCountry?.properties.name || '...'}</h2>
                            <p id="feedback-message" class="text-sm text-yellow-400 h-6"></p>
                        </div>
                        ${isTimedMode ? `
                        <div>
                            <p class="text-base text-slate-400">Time Left</p>
                            <p id="timer" class="text-2xl sm:text-4xl font-bold transition-colors ${timerClass}">${timeLeft}</p>
                        </div>` : ''}
                        <div class="flex justify-around items-center w-full">
                            <div>
                                <p class="text-base text-slate-400">Lives</p>
                                <div class="flex justify-center space-x-1 mt-1">${hearts}</div>
                            </div>
                            <div>
                                <p class="text-base text-slate-400">Streak</p>
                                <p class="text-2xl font-bold">${streak} üî•</p>
                            </div>
                        </div>
                        <div>
                            <p class="text-base text-slate-400">Score</p>
                            <p class="text-2xl sm:text-4xl font-bold">${score}</p>
                        </div>
                        <button id="hint-btn" ${hintsLeft <= 0 || !!correctGuessId || !!revealedHintCountryId ? 'disabled' : ''} class="px-5 py-2 bg-teal-600 text-white font-bold rounded-lg hover:bg-teal-500 transition-colors shadow-md disabled:bg-slate-700 disabled:cursor-not-allowed">
                            Hint (${hintsLeft})
                        </button>
                    </div>`;
            }
            gameInfoPanel.innerHTML = content;
            if (gameStatus === GameStatus.GAME_OVER) {
                document.getElementById('play-again-btn').addEventListener('click', () => startGame());
            }
            if (gameStatus === GameStatus.PLAYING && gameMode === 'PLAY') {
                document.getElementById('hint-btn').addEventListener('click', handleHintClick);
            }
        }
        
        function updateFeedbackMessage(message) {
            const el = document.getElementById('feedback-message');
            if (el) el.textContent = message;
        }

        function updateHighScore() {
            highScoreEl.innerHTML = `${highScore} <span class="text-base font-normal text-slate-400">pts</span>`;
        }
        
        // --- Map Rendering ---
        function renderMap() {
            const getFillColor = (d) => {
                let colorClass = 'fill-slate-700 hover:fill-slate-600';
                if (gameMode === 'PLAY') {
                    if (d.id === correctGuessId) return 'fill-green-500';
                    if (gameStatus === GameStatus.PLAYING) {
                        if (wrongGuesses.includes(d.id)) return 'fill-red-500';
                        if (d.id === selectedCountryId) return 'fill-yellow-500';
                        if (d.id === revealedHintCountryId) return 'fill-green-500';
                    } else if (gameStatus === GameStatus.GAME_OVER) {
                        if (d.id === targetCountry.id) return 'fill-green-500';
                        if (wrongGuesses.includes(d.id) || (d.id === selectedCountryId && d.id !== targetCountry.id)) return 'fill-red-500';
                    }
                }
                return colorClass;
            };

            g.selectAll('path').data(countries, d => d.id)
                .join('path')
                .attr('d', pathGenerator)
                .attr('class', d => `${getFillColor(d)} stroke-slate-500 stroke-[0.5] transition-colors duration-300`);

            // Labels for Study Mode
            g.selectAll('text').remove();
            if (gameMode === 'STUDY') {
                g.selectAll('text').data(countries).enter()
                    .append('text')
                    .attr('x', d => pathGenerator.centroid(d)[0])
                    .attr('y', d => pathGenerator.centroid(d)[1])
                    .text(d => d.properties.name)
                    .attr('text-anchor', 'middle')
                    .attr('dominant-baseline', 'middle')
                    .attr('class', 'fill-white/90 font-semibold pointer-events-none')
                    .style('font-size', d => {
                        const area = pathGenerator.area(d);
                        if (area * currentTransform.k < 2) return '0px';
                        const fontSize = Math.min(8 / currentTransform.k, area / 100);
                        return fontSize < 1.0 ? '0px' : `${fontSize}px`;
                    })
                    .style('stroke', 'rgba(0,0,0,0.5)')
                    .style('stroke-width', 0.2);
            }

            // Marker
            g.selectAll('circle.marker').remove();
            if (marker && gameStatus === GameStatus.PLAYING) {
                g.append('circle')
                    .attr('cx', marker.x)
                    .attr('cy', marker.y)
                    .attr('r', 5 / currentTransform.k)
                    .attr('class', 'marker fill-blue-400 stroke-white pointer-events-none')
                    .style('stroke-width', 2 / currentTransform.k);
            }

            // Update cursor
            const cursor = gameMode === 'STUDY' ? 'cursor-grab' : (gameStatus === GameStatus.PLAYING ? 'cursor-crosshair' : 'cursor-default');
            svg.style('cursor', cursor);
        }

        // --- Game Logic ---
        const shuffleArray = (array) => {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };
        
        function startGame(countryData = countries) {
            clearTimeout(timerId);
            score = 0;
            lives = 3;
            streak = 0;
            selectedCountryId = null;
            wrongGuesses = [];
            correctGuessId = null;
            hintsLeft = 3;
            revealedHintCountryId = null;
            marker = null;
            
            const shuffled = shuffleArray(countryData);
            playableCountries = shuffled.slice(1);
            targetCountry = shuffled[0];
            gameStatus = GameStatus.PLAYING;
            
            resetTimer();
            renderGameInfo();
            renderMap();
        }

        function selectNewCountry() {
            clearTimeout(timerId);
            if (playableCountries.length > 0) {
                const newPlayable = [...playableCountries];
                targetCountry = newPlayable.shift();
                playableCountries = newPlayable;
                selectedCountryId = null;
                wrongGuesses = [];
                correctGuessId = null;
                revealedHintCountryId = null;
                marker = null; // Clear marker for new round
                resetTimer();
                renderGameInfo();
                renderMap();
            } else {
                gameOver();
            }
        }

        function handleRoundFailure(message) {
            if (!targetCountry) return;
            
            streak = 0;
            lives -= 1;
            correctGuessId = targetCountry.id;
            updateFeedbackMessage(message);
            
            renderMap();
            renderGameInfo();

            setTimeout(() => {
                if (lives > 0) {
                    selectNewCountry();
                } else {
                    gameOver();
                }
            }, 2500);
        }

        function gameOver() {
            clearTimeout(timerId);
            gameStatus = GameStatus.GAME_OVER;
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('countryGuesserHighScore', score.toString());
                updateHighScore();
            }
            renderGameInfo();
            renderMap();
        }
        
        function handleCountryGuess(guessedCountry) {
            if (gameStatus !== GameStatus.PLAYING || !targetCountry || correctGuessId) return;
            
            if (!guessedCountry) {
                selectedCountryId = null;
                renderMap();
                return;
            }
            
            selectedCountryId = guessedCountry.id;
            
            if (guessedCountry.id === targetCountry.id) {
                clearTimeout(timerId);
                score++;
                streak++;
                correctGuessId = guessedCountry.id;
                updateFeedbackMessage(`Correct! It's ${guessedCountry.properties.name}.`);
                renderGameInfo();
                renderMap();
                setTimeout(selectNewCountry, 1500);
            } else {
                if (wrongGuesses.includes(guessedCountry.id)) {
                    renderMap();
                    return;
                }
                
                wrongGuesses.push(guessedCountry.id);
                const message = `Incorrect. The answer was ${targetCountry.properties.name}.`;
                clearTimeout(timerId);
                handleRoundFailure(message);
            }
        }
        
        function handleHintClick() {
            if (!targetCountry || hintsLeft <= 0 || revealedHintCountryId || correctGuessId) return;
            
            if (targetCountry.id) {
              revealedHintCountryId = targetCountry.id;
              updateFeedbackMessage('Hint used! The correct country is highlighted in green.');
              setTimeout(() => {
                const el = document.getElementById('feedback-message');
                if (el && el.textContent === 'Hint used! The correct country is highlighted in green.') {
                    el.textContent = '';
                }
              }, 2500);
            }
            hintsLeft--;
            renderGameInfo();
            renderMap();
        }

        // --- Timer Logic ---
        function resetTimer() {
            timeLeft = 60;
            if (isTimedMode && gameStatus === GameStatus.PLAYING) {
                countdown();
            }
        }

        function countdown() {
            if (!isTimedMode || gameStatus !== GameStatus.PLAYING || gameMode !== 'PLAY' || correctGuessId) {
                return;
            }
            timerId = setTimeout(() => {
                timeLeft--;
                const timerEl = document.getElementById('timer');
                if (timerEl) {
                    timerEl.textContent = timeLeft;
                    if (timeLeft < 10) {
                        timerEl.classList.add('text-red-500', 'animate-pulse');
                    }
                }
                if (timeLeft <= 0) {
                    handleRoundFailure(`Time's up! The answer was ${targetCountry?.properties.name}.`);
                } else {
                    countdown();
                }
            }, 1000);
        }

        // --- Event Handlers ---
        function handleMapClick(event) {
            if (gameMode !== 'PLAY' || gameStatus !== GameStatus.PLAYING) return;
            
            const [svgX, svgY] = pointer(event, svg.node());
            const [transformedX, transformedY] = currentTransform.invert([svgX, svgY]);
            marker = { x: transformedX, y: transformedY };
            
            const coords = projection.invert([transformedX, transformedY]);
            
            if (coords) {
                const clickedCountry = countries.find(c => c.geometry && geoContains(c, coords));
                handleCountryGuess(clickedCountry || null);
            } else {
                handleCountryGuess(null);
            }
        }
        
        // --- Initialization ---
        async function init() {
            // Load high score
            const storedScore = localStorage.getItem('countryGuesserHighScore');
            if (storedScore) {
                highScore = parseInt(storedScore, 10);
                updateHighScore();
            }

            // Set up D3
            projection = geoMercator().scale(150).translate([800 / 2, 450 / 2]);
            pathGenerator = geoPath().projection(projection);

            zoomBehavior = zoom()
                .scaleExtent([1, 10])
                .on('zoom', (event) => {
                    currentTransform = event.transform;
                    g.attr('transform', currentTransform);
                    renderMap();
                });
            
            svg.call(zoomBehavior);
            svg.on('dblclick.zoom', null); // Disable double-click zoom

            // Attach event listeners
            document.getElementById('zoom-in').addEventListener('click', () => svg.transition().call(zoomBehavior.scaleBy, 1.5));
            document.getElementById('zoom-out').addEventListener('click', () => svg.transition().call(zoomBehavior.scaleBy, 0.75));
            svg.on('click', handleMapClick);

            document.getElementById('study-mode-toggle').addEventListener('click', () => {
                gameMode = gameMode === 'PLAY' ? 'STUDY' : 'PLAY';
                const button = document.getElementById('study-mode-toggle');
                const switchEl = document.getElementById('study-mode-switch');
                if (gameMode === 'STUDY') {
                    button.classList.replace('bg-gray-600', 'bg-cyan-500');
                    switchEl.classList.replace('translate-x-1', 'translate-x-6');
                    clearTimeout(timerId);
                } else {
                    button.classList.replace('bg-cyan-500', 'bg-gray-600');
                    switchEl.classList.replace('translate-x-6', 'translate-x-1');
                    startGame();
                }
                renderGameInfo();
                renderMap();
            });

            document.getElementById('timed-mode-toggle').addEventListener('click', () => {
                isTimedMode = !isTimedMode;
                const button = document.getElementById('timed-mode-toggle');
                const switchEl = document.getElementById('timed-mode-switch');
                if (isTimedMode) {
                    button.classList.replace('bg-gray-600', 'bg-cyan-500');
                    switchEl.classList.replace('translate-x-1', 'translate-x-6');
                } else {
                    button.classList.replace('bg-cyan-500', 'bg-gray-600');
                    switchEl.classList.replace('translate-x-6', 'translate-x-1');
                }
                startGame();
            });

            // Fetch map data and start game
            try {
                renderGameInfo();
                const response = await fetch(WORLD_MAP_URL);
                if (!response.ok) throw new Error('Failed to fetch map data');
                const worldData = await response.json();
                
                const countriesGeoJSON = feature(worldData, worldData.objects.countries);
                countries = countriesGeoJSON.features.filter(c => c.properties.name && c.id !== '010');
                
                startGame(countries);
            } catch (error) {
                console.error('Error loading map data:', error);
                gameInfoPanel.innerHTML = `<div class="text-center text-red-500">Failed to load map data. Please refresh the page.</div>`;
            }
        }

        init();
    </script>
  </body>
</html>
